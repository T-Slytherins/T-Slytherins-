#!/usr/bin/env python3
"""
T-SLYTHERINS Main Reconnaissance Script
"""

import sys
import os
import time
import threading
import subprocess
import shlex
import signal
from pathlib import Path
from shutil import which

# Add modules directory to Python path
current_dir = os.path.dirname(os.path.abspath(__file__))
modules_dir = os.path.join(current_dir, 'modules')
sys.path.insert(0, modules_dir)

try:
    from progress import Spinner
    import utils
except ImportError as e:
    print(f"[!] Import error: {e}", file=sys.stderr)
    print(f"[!] Current Python path: {sys.path}", file=sys.stderr)
    print(f"[!] Looking for modules in: {modules_dir}", file=sys.stderr)
    sys.exit(1)

def print_banner():
    """Print the tool banner - Fixed escape sequences"""
    banner = r"""
╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                                                                                                      ║
║               _______      _______          __   __ _______ _     _ _______  ______ _____ __   _ _______             ║
║                  |         |______   |        \_/      |    |_____| |______ |_____/   |   | \  | |______             ║
║                  |         ______|   |_____    |       |    |     | |______ |    \_ __|__ |  \_|  ______|            ║
║                                                                                                                      ║
║                                            T-SLYTHERINS Reconnaissance Suite                                         ║
║                                                                                                                      ║
║           Advanced Automated Reconnaissance Framework ~ Owned by T-Slytherins ~ Crafted by Pr0fessor_SnApe           ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝
"""
    print(banner)

def check_tools():
    """Check if required tools are installed"""
    required_tools = [
        ('subfinder', 'Subfinder is not installed. Run installer.sh'),
        ('amass', 'Amass is not installed. Run installer.sh'),
        ('httpx', 'HTTPX is not installed. Run installer.sh'),
        ('nuclei', 'Nuclei is not installed. Run installer.sh'),
        ('nmap', 'Nmap is not installed. Install with: sudo apt install nmap'),
        ('katana', 'Katana is not installed. Run installer.sh'),
    ]
    
    print("[*] Checking required tools...")
    missing_tools = []
    
    for tool, message in required_tools:
        if not which(tool):
            print(f"  [!] {tool}: {message}")
            missing_tools.append(tool)
        else:
            print(f"  [✓] {tool}")
    
    if missing_tools:
        print(f"\n[!] Missing tools: {', '.join(missing_tools)}")
        return False
    return True

def run_module(module_name, domain, output_dir):
    """Run a module and track its progress"""
    log_file = f"{output_dir}/{module_name}.log"
    done_file = f"{output_dir}/{module_name}.done"
    
    # Clean up old done file
    if os.path.exists(done_file):
        os.remove(done_file)
    
    module_map = {
        'subdomains': ['python3', f'{modules_dir}/subdomains.py'],
        'dns': ['python3', f'{modules_dir}/dnsscan.py'],
        'httprobe': ['python3', f'{modules_dir}/httprobe.py'],
        'portscan': ['python3', f'{modules_dir}/portscan.py'],
        'vulnscan': ['python3', f'{modules_dir}/vulnscan.py'],
        'crawl': ['python3', f'{modules_dir}/crawl.py'],
        'screenshots': ['python3', f'{modules_dir}/screenshots.py']
    }
    
    if module_name not in module_map:
        print(f"[!] Unknown module: {module_name}", file=sys.stderr)
        return None
    
    cmd_list = module_map[module_name] + [domain, output_dir]
    
    try:
        process = utils.launch_module_in_terminal(cmd_list, log_file, done_file, f"{module_name} - {domain}")
        return process
    except Exception as e:
        print(f"[!] Failed to start {module_name}: {e}", file=sys.stderr)
        return None

def cleanup(processes, spinner):
    """Cleanup function for graceful exit"""
    if spinner:
        spinner.stop()
    
    print("\n\n[!] Cleaning up...")
    
    # Kill any running processes
    for display_name, process in processes:
        if process and process.poll() is None:
            try:
                process.terminate()
                process.wait(timeout=5)
                print(f"[*] Terminated {display_name}")
            except:
                try:
                    process.kill()
                except:
                    pass
    
    print("[*] Cleanup complete")

def main():
    print_banner()
    
    # Check if running in venv
    venv_active = hasattr(sys, 'real_prefix') or 'VIRTUAL_ENV' in os.environ
    if not venv_active:
        print("[!] WARNING: Not running in virtual environment")
        print("[*] Recommended: source venv/bin/activate")
        print("[*] Continue anyway? (y/N): ", end='')
        response = input().strip().lower()
        if response != 'y':
            print("[*] Exiting. Please activate virtual environment.")
            sys.exit(0)
    
    # Get target domain from command line or prompt
    if len(sys.argv) > 1:
        domain = sys.argv[1]
    else:
        try:
            domain = input("[?] Enter target domain: ").strip()
        except KeyboardInterrupt:
            print("\n\n[!] Scan cancelled by user")
            sys.exit(0)
        except EOFError:
            print("\n\n[!] No input received")
            sys.exit(1)
    
    if not domain:
        print("[!] No domain provided", file=sys.stderr)
        sys.exit(1)
    
    # Check tools
    if not check_tools():
        print("\n[!] Please install missing tools and try again")
        sys.exit(1)
    
    # Create output directory
    output_dir = f"T-SLYTHERINS-OUTPUT-{domain}"
    try:
        Path(output_dir).mkdir(exist_ok=True)
    except Exception as e:
        print(f"[!] Failed to create output directory: {e}", file=sys.stderr)
        sys.exit(1)
    
    print(f"\n[*] Target: {domain}")
    print(f"[*] Output directory: {output_dir}")
    print("-" * 60)
    
    # Initialize spinner
    spinner = Spinner()
    
    # Define modules and their display names
    modules = [
        ('subdomains', 'Subdomain Enumeration'),
        ('dns', 'DNS Reconnaissance'),
        ('httprobe', 'HTTP Probing'),
        ('portscan', 'Port Scanning'),
        ('vulnscan', 'Vulnerability Scan'),
        ('crawl', 'Web Crawling'),
        ('screenshots', 'Screenshot Capture')
    ]
    
    # Set initial state
    for module_name, display_name in modules:
        spinner.set_module_running(display_name, False)
    
    processes = []
    
    # Setup signal handler for graceful shutdown
    def signal_handler(signum, frame):
        cleanup(processes, spinner)
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        # Start spinner
        spinner.start()
        
        # Run modules
        for module_name, display_name in modules:
            print(f"\n[*] Starting {display_name}...")
            spinner.set_module_running(display_name, True)
            
            process = run_module(module_name, domain, output_dir)
            if process:
                processes.append((display_name, process))
            
            # Wait for module to complete
            done_file = f"{output_dir}/{module_name}.done"
            max_wait = 7200  # 2 hours max per module
            wait_time = 0
            
            while not os.path.exists(done_file) and wait_time < max_wait:
                time.sleep(2)
                wait_time += 2
            
            if wait_time >= max_wait:
                print(f"[!] {display_name} timed out after 2 hours")
            
            spinner.set_module_running(display_name, False)
            print(f"[✓] {display_name} completed")
        
        # Stop spinner
        spinner.stop()
        
        print("\n" + "=" * 60)
        print("[✓] All modules completed!")
        
        # Generate report
        print("[*] Generating HTML report...")
        try:
            report_cmd = ["python3", f"{modules_dir}/report.py", output_dir]
            subprocess.run(report_cmd, check=False, timeout=300)
            print("[✓] Report generated successfully")
        except subprocess.TimeoutExpired:
            print("[!] Report generation timed out")
        except Exception as e:
            print(f"[!] Error generating report: {e}")
        
        print(f"\n[✓] Reconnaissance complete!")
        print(f"[*] Results saved to: {output_dir}/")
        print(f"[*] To view report: firefox {output_dir}/report.html")
        print("[*] Or open in browser: file://" + os.path.abspath(f"{output_dir}/report.html"))
        print("=" * 60)
        
    except KeyboardInterrupt:
        cleanup(processes, spinner)
        print("\n[!] Scan interrupted by user")
        sys.exit(1)
    
    except Exception as e:
        cleanup(processes, spinner)
        print(f"\n[!] Error during scan: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
