#!/usr/bin/env python3

import os
import subprocess
import shutil
import time

GREEN = "\033[92m"
RESET = "\033[0m"

TOOLS = {
    "subfinder": "github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest",
    "httpx": "github.com/projectdiscovery/httpx/cmd/httpx@latest",
    "katana": "github.com/projectdiscovery/katana/cmd/katana@latest",
    "assetfinder": "github.com/tomnomnom/assetfinder@latest"
}

def ensure_tool(tool):
    """Auto-install tool if missing."""
    if shutil.which(tool):
        return True

    print(GREEN + f"[!] Missing {tool}, installing..." + RESET)
    if "go" not in os.environ["PATH"]:
        subprocess.run("source /etc/profile.d/golang.sh", shell=True)

    subprocess.run(f"go install {TOOLS[tool]}", shell=True)
    return shutil.which(tool) is not None

def ensure_all_tools():
    print(GREEN + "[*] Checking required tools..." + RESET)
    for tool in TOOLS:
        ensure_tool(tool)

def banner():
    print(GREEN + r"""
 _______      _______        __   __ _______ _     _ _______  ______ _____ __   _ _______
    |         |______ |        \_/      |    |_____| |______ |_____/   |   | \  | |______
    |         ______| |_____    |       |    |     | |______ |    \_ __|__ |  \_| ______|

      T  S L Y T H E R I N S   R E C O N   S U I T E
    """ + RESET)

def run_cmd(cmd, output_file=None):
    print(GREEN + f"[+] Executing: {' '.join(cmd)}" + RESET)
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        if output_file:
            with open(output_file, "a") as f:
                f.write(result.stdout)
    except Exception as e:
        print(f"[ERROR] {e}")

def recon(domain):
    ensure_all_tools()

    outdir = "T-SLYTHERINS-OUTPUT"
    os.makedirs(outdir, exist_ok=True)

    all_subs = f"{outdir}/all_subdomains.txt"
    live_json = f"{outdir}/live.json"

    print(GREEN + f"\n[!] Starting recon on: {domain}\n" + RESET)

    # SUBDOMAIN COLLECTION
    run_cmd(["amass", "enum", "-passive", "-d", domain], all_subs)
    run_cmd(["subfinder", "-silent", "-d", domain], all_subs)
    run_cmd(["assetfinder", domain], all_subs)

    subprocess.run(f"sort -u {all_subs} -o {all_subs}", shell=True)

    # HTTP PROBING
    run_cmd([
        "httpx",
        "-l", all_subs,
        "-title", "-status-code", "-tech-detect",
        "-json"
    ], live_json)

    # CRAWLING
    run_cmd(["katana", "-list", all_subs, "-o", f"{outdir}/katana.txt"])

    print(GREEN + "\n[✔] Recon Complete!")
    print(f"[✔] Output saved in: {outdir}/\n" + RESET)

if __name__ == "__main__":
    banner()
    target = input(GREEN + "Enter target domain: " + RESET).strip()
    recon(target)
