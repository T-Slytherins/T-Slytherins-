#!/usr/bin/env python3

"""
T-SLYTHERINS Recon Suite - Main Script 
"""

import os
import sys
import time
import signal
import subprocess
import threading
import re
import shlex
from pathlib import Path
from shutil import which
from progress import Spinner  # Integrated progress.py

# Color codes
class Colors:
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    PURPLE = '\033[0;35m'
    CYAN = '\033[0;36m'
    NC = '\033[0m'

# Global process list for cleanup
processes = []

def signal_handler(sig, frame):
    """Handle Ctrl+C gracefully"""
    print(f"\n{Colors.YELLOW}[*] Shutting down gracefully...{Colors.NC}")
    cleanup_processes()
    sys.exit(0)

def cleanup_processes():
    """Kill all spawned processes"""
    for proc in processes:
        try:
            if proc.poll() is None:  # Process is still running
                proc.terminate()
                proc.wait(timeout=3)
        except subprocess.TimeoutExpired:
            proc.kill()

def check_requirements():
    """Verify all required tools are installed"""
    print(f"{Colors.YELLOW}[*] Checking requirements...{Colors.NC}")
    
    required_tools = {
        'amass': 'Amass',
        'subfinder': 'Subfinder',
        'assetfinder': 'Assetfinder',
        'httpx': 'Httpx',
        'nmap': 'Nmap',
        'nuclei': 'Nuclei',
        'katana': 'Katana',
        'aquatone': 'Aquatone'
    }
    
    missing = []
    for tool, name in required_tools.items():
        if not which(tool):
            missing.append(name)
    
    if missing:
        print(f"{Colors.RED}[!] Missing tools: {', '.join(missing)}{Colors.NC}")
        print(f"{Colors.YELLOW}[*] Run 'sudo ./installer.sh' first{Colors.NC}")
        return False
    
    print(f"{Colors.GREEN}[✓] All tools available{Colors.NC}")
    return True

def validate_domain(domain):
    """Validate domain name to prevent injection"""
    if not re.match(r'^[a-zA-Z0-9.-]+$', domain):
        print(f"{Colors.RED}[!] Invalid domain: {domain}{Colors.NC}")
        sys.exit(1)
    return domain

def create_output_dir(domain):
    """Create timestamped output directory"""
    timestamp = time.strftime("%Y%m%d-%H%M%S")
    output_dir = f"T-SLYTHERINS-OUTPUT-{domain}-{timestamp}"
    Path(output_dir).mkdir(parents=True, exist_ok=True)
    return output_dir

def run_module(module_name, module_cmd, output_file, spinner):
    """Run module and monitor progress"""
    spinner.set_module_running(module_name, True)
    proc = subprocess.Popen(module_cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    processes.append(proc)
    with open(output_file, 'w') as f:
        for line in iter(proc.stdout.readline, b''):
            f.write(line.decode())
    proc.wait()
    spinner.set_module_running(module_name, False)

def print_banner():
    banner = """
╔═════════════════════════════════════════════════════════════════════════════════════════════╗                                                                                                                    
║                                                                                             ║                                                                                                                    
║  _______      _______        __   __ _______ _     _ _______  ______ _____ __   _ _______   ║                                                                                                                    
║     |         |______ |        \_/      |    |_____| |______ |_____/   |   | \  | |______   ║                                                                                                                    
║     |         ______| |_____    |       |    |     | |______ |    \_ __|__ |  \_|  ______|  ║                                                                                                                    
║                                                                                             ║                                                                                                                    
║                                                                                             ║                                                                                                                    
║       Advanced Reconnaissance Framework v2.0 ~ T-SLYTHERINS Team ~ Pr0Fessor_SnApe          ║                                                                                                                    
╚═════════════════════════════════════════════════════════════════════════════════════════════╝  
"""
    print(Colors.CYAN + banner + Colors.NC)

def main():
    print_banner()
    signal.signal(signal.SIGINT, signal_handler)
    
    if not check_requirements():
        sys.exit(1)
    
    domain = validate_domain(input(f"{Colors.CYAN}Enter domain (e.g., example.com): {Colors.NC}").strip())
    
    output_dir = create_output_dir(domain)
    print(f"{Colors.GREEN}[✓] Output directory: {output_dir}{Colors.NC}")
    
    if not os.path.exists('modules'):
        print(f"{Colors.RED}[!] Modules directory not found{Colors.NC}")
        sys.exit(1)
    
    print(f"\n{Colors.YELLOW}[*] Starting reconnaissance...{Colors.NC}\n")
    
    # Module configurations (use lists for safety)
    modules = [
        {
            'name': 'Subdomain Enumeration',
            'command': ['python3', 'modules/subdomains.py', domain, output_dir],
            'output': f'{output_dir}/subdomains.log'
        },
        {
            'name': 'DNS Reconnaissance',
            'command': ['python3', 'modules/dnsscan.py', domain, output_dir],
            'output': f'{output_dir}/dns.log'
        },
        {
            'name': 'Port Scanning',
            'command': ['python3', 'modules/portscan.py', domain, output_dir],
            'output': f'{output_dir}/portscan.log'
        },
        {
            'name': 'HTTP Probing',
            'command': ['python3', 'modules/httprobe.py', domain, output_dir],
            'output': f'{output_dir}/httprobe.log'
        },
        {
            'name': 'Vulnerability Scanning',
            'command': ['python3', 'modules/vulnscan.py', domain, output_dir],
            'output': f'{output_dir}/vulnscan.log'
        },
        {
            'name': 'Web Crawling',
            'command': ['python3', 'modules/crawl.py', domain, output_dir],
            'output': f'{output_dir}/crawl.log'
        }
    ]
    
    spinner = Spinner()
    spinner.start()
    
    threads = []
    for module in modules:
        print(f"{Colors.CYAN}[*] Launching: {module['name']}{Colors.NC}")
        t = threading.Thread(target=run_module, args=(module['name'], module['command'], module['output'], spinner))
        t.start()
        threads.append(t)
        time.sleep(1)  # Stagger launches
    
    # Wait for all
    for t in threads:
        t.join()
    
    spinner.stop()
    
    print(f"\n\n{Colors.GREEN}[✓] Reconnaissance complete!{Colors.NC}")
    print(f"{Colors.YELLOW}[*] Output saved to: {output_dir}{Colors.NC}")
    print(f"{Colors.YELLOW}[*] Generate report: python3 modules/report.py {output_dir}{Colors.NC}")

if __name__ == "__main__":
    main()
