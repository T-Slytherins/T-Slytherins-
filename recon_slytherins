#!/usr/bin/env python3

import os
import subprocess
import time
import sys
import shutil
import signal

GREEN = "\033[92m"
RESET = "\033[0m"

# -------------------------------------------------------
# Ensure XFCE terminal is installed
# -------------------------------------------------------
def ensure_xfce_terminal():
    if not shutil.which("xfce4-terminal"):
        print(GREEN + "[!] xfce4-terminal not found. Installing..." + RESET)
        subprocess.run(["sudo", "apt", "update", "-y"])
        subprocess.run(["sudo", "apt", "install", "xfce4-terminal", "-y"])
    else:
        print(GREEN + "[‚úî] xfce4-terminal already installed." + RESET)

# -------------------------------------------------------
# Banner
# -------------------------------------------------------
def banner():
    print(GREEN + r"""
 _______      _______        __   __ _______ _     _ _______  ______ _____ __   _ _______
    |         |______ |        \_/      |    |_____| |______ |_____/   |   | \  | |______
    |         ______| |_____    |       |    |     | |______ |    \_ __|__ |  \_| ______|

                 T  S L Y T H E R I N S   R E C O N   S U I T E
    """ + RESET)

# -------------------------------------------------------
# Launch snake in separate terminal
# -------------------------------------------------------
def launch_snake_terminal():
    ensure_xfce_terminal()
    print(GREEN + "[*] Launching snake animation window..." + RESET)

    snake_frames = [
        "(üêç     )",
        "( üêç    )",
        "(  üêç   )",
        "(   üêç  )",
        "(    üêç )",
        "(     üêç)",
        "(    üêç )",
        "(   üêç  )",
        "(  üêç   )",
        "( üêç    )"
    ]

    # Temporary Python script for animation
    tmp_file = "/tmp/snake_animation.py"
    with open(tmp_file, "w") as f:
        f.write(f"""
import time
frames = {snake_frames}
try:
    while True:
        for f in frames:
            print("\\033[92m" + f + "\\033[0m")
            time.sleep(0.2)
except KeyboardInterrupt:
    pass
""")

    xfce_path = shutil.which("xfce4-terminal") or "/usr/bin/xfce4-terminal"
    if os.path.exists(xfce_path):
        return subprocess.Popen([
            xfce_path,
            "--geometry=50x10+50+50",
            "--hold",       # Keep terminal open while animation runs
            "-x", "python3", tmp_file
        ])
    print("[!] Could not launch snake animation. No supported terminal.")
    return None

# -------------------------------------------------------
# Safe command execution
# -------------------------------------------------------
def run_cmd(cmd, output_file=None):
    print(GREEN + f"[+] Executing: {' '.join(cmd)}" + RESET)
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        if output_file:
            with open(output_file, "a") as f:
                f.write(result.stdout)
    except Exception as e:
        print(f"[ERROR] {e}")

# -------------------------------------------------------
# Main recon routine
# -------------------------------------------------------
def recon(domain):
    outdir = "T-SLYTHERINS-OUTPUT"
    os.makedirs(outdir, exist_ok=True)

    all_subs = f"{outdir}/all_subdomains.txt"
    live_json = f"{outdir}/live.json"

    print(GREEN + f"\n[!] Starting recon on: {domain}\n" + RESET)
    time.sleep(1)

    # Launch snake in separate terminal
    snake_proc = launch_snake_terminal()

    # -----------------------------
    # Subdomain enumeration
    # -----------------------------
    print(GREEN + "[1] Gathering subdomains..." + RESET)
    run_cmd(["amass", "enum", "-passive", "-d", domain], all_subs)
    run_cmd(["subfinder", "-silent", "-d", domain], all_subs)
    run_cmd(["assetfinder", domain], all_subs)

    print(GREEN + "\n[+] Deduplicating subdomains..." + RESET)
    subprocess.run(f"sort -u {all_subs} -o {all_subs}", shell=True)

    # -----------------------------
    # HTTP probing
    # -----------------------------
    print(GREEN + "\n[2] Probing for live hosts with httpx..." + RESET)
    run_cmd([
        "httpx",
        "-l", all_subs,
        "-title",
        "-status-code",
        "-tech-detect",
        "-json"
    ], live_json)

    # -----------------------------
    # URL crawling with Katana
    # -----------------------------
    print(GREEN + "\n[3] Crawling URLs with Katana..." + RESET)
    run_cmd(["katana", "-list", all_subs, "-o", f"{outdir}/katana.txt"])

    # -----------------------------
    # Stop snake
    # -----------------------------
    if snake_proc:
        try:
            snake_proc.terminate()
        except Exception:
            pass

    print(GREEN + "\n[‚úî] Recon Complete!")
    print(f"[‚úî] Output saved in: {outdir}/\n" + RESET)

# -------------------------------------------------------
# Main entry
# -------------------------------------------------------
if __name__ == "__main__":
    banner()
    target = input(GREEN + "Enter target domain: " + RESET)
    recon(target)
